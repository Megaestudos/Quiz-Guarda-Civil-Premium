<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Painel Admin | Plataforma de Simulados</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1220;
  --card:#0f172a;
  --border:#1e293b;
  --primary:#2563eb;
  --primary-dark:#1e40af;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --success:#22c55e;
  --danger:#f87171;
  --radius:16px;
}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,Arial,sans-serif;
  background:
    radial-gradient(900px 600px at 15% 15%, rgba(37,99,235,.18), transparent 60%),
    radial-gradient(800px 600px at 85% 20%, rgba(16,185,129,.12), transparent 60%),
    var(--bg);
  color:var(--text);
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px 30px;
  font-weight:700;
  font-size:18px;
}
.container{
  display:grid;
  gap:24px;
  padding:20px 30px;
  grid-template-columns: repeat(auto-fit,minmax(250px,1fr));
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:22px;
  box-shadow:0 20px 40px rgba(0,0,0,.45);
  backdrop-filter: blur(10px);
}
.card h3{
  margin:0 0 8px;
  font-size:16px;
  color:var(--muted);
}
.card .value{
  font-size:24px;
  font-weight:800;
}
button{
  padding:10px 16px;
  border-radius:12px;
  border:none;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
button:hover{
  opacity:.85;
}
#exportCSV{
  margin-top:10px;
}
</style>
</head>
<body>

<header>
  <span>Painel Admin</span>
  <button id="logoutBtn">Sair</button>
</header>

<div class="container">
  <div class="card">
    <h3>Usuários</h3>
    <div class="value" id="userCount">0</div>
  </div>
  <div class="card">
    <h3>Último login</h3>
    <div class="value" id="lastLogin">--</div>
  </div>
  <div class="card">
    <h3>Relatórios CSV</h3>
    <button id="exportCSV">Exportar CSV</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB36ZszS8v_DeOn3at7zEo_tFq86WU0sI4",
  authDomain: "simulados-concursos-22c91.firebaseapp.com",
  projectId: "simulados-concursos-22c91"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const userCountEl = document.getElementById("userCount");
const lastLoginEl = document.getElementById("lastLogin");
const exportBtn = document.getElementById("exportCSV");
const logoutBtn = document.getElementById("logoutBtn");

// Verifica se está logado
auth.onAuthStateChanged(user=>{
  if(!user){
    window.location.href="login.html";
  }
});

// ==========================
// BUSCA USUÁRIOS FIRESTORE
// ==========================
async function loadUsers(){
  try{
    const usersCol = collection(db,"users"); // precisa criar coleção "users" e salvar cada usuário lá
    const usersSnapshot = await getDocs(usersCol);
    const users = usersSnapshot.docs.map(doc=>doc.data());

    // Contador
    userCountEl.innerText = users.length;

    // Último login
    if(users.length>0){
      users.sort((a,b)=> b.lastLogin - a.lastLogin);
      const last = new Date(users[0].lastLogin);
      lastLoginEl.innerText = last.toLocaleString("pt-BR");
    }
  }catch(err){
    console.error(err);
  }
}

// ==========================
// EXPORT CSV
// ==========================
exportBtn.onclick = async()=>{
  try{
    const usersCol = collection(db,"users");
    const usersSnapshot = await getDocs(usersCol);
    const users = usersSnapshot.docs.map(doc=>doc.data());

    let csv = "Email,Último Login\n";
    users.forEach(u=>{
      csv += `${u.email},${new Date(u.lastLogin).toLocaleString("pt-BR")}\n`;
    });

    const blob = new Blob([csv],{type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url;
    a.download="relatorio_usuarios.csv";
    a.click();
    URL.revokeObjectURL(url);
  }catch(err){
    console.error(err);
  }
}

// LOGOUT
logoutBtn.onclick = async()=>{
  await auth.signOut();
  window.location.href="login.html";
}

loadUsers();
</script>

</body>
</html>
